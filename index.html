<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecture Backlog Tracker</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <!-- Cropper.js for image cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

  <style>
    /* Apple-inspired Design System */
    :root {
      /* Typography Scale - SF Pro inspired */
      --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;

      /* 8-Point Spacing System */
      --space-1: 4px;
      /* 0.25rem */
      --space-2: 8px;
      /* 0.5rem */
      --space-3: 12px;
      /* 0.75rem */
      --space-4: 16px;
      /* 1rem */
      --space-5: 20px;
      /* 1.25rem */
      --space-6: 24px;
      /* 1.5rem */
      --space-7: 28px;
      /* 1.75rem */
      --space-8: 32px;
      /* 2rem */
      --space-10: 40px;
      /* 2.5rem */
      --space-12: 48px;
      /* 3rem */
      --space-16: 64px;
      /* 4rem */
      --space-20: 80px;
      /* 5rem */

      /* Border Radius Scale */
      --radius-xs: 4px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-full: 9999px;

      /* Light Theme Colors - Apple-inspired */
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-400: #a3a3a3;
      --gray-500: #737373;
      --gray-600: #525252;
      --gray-700: #404040;
      --gray-800: #262626;
      --gray-900: #171717;

      /* Semantic Colors */
      --blue-500: #007AFF;
      --blue-600: #0056CC;
      --green-500: #34C759;
      --green-600: #248A3D;
      --orange-500: #FF9500;
      --orange-600: #CC7700;
      --red-500: #FF3B30;
      --red-600: #CC2E24;
      --purple-500: #AF52DE;
      --purple-600: #8B42B8;

      /* Theme Variables */
      --background: #ffffff;
      --background-secondary: #f8fafc;
      --background-tertiary: #f1f5f9;
      --surface: #ffffff;
      --surface-secondary: rgba(255, 255, 255, 0.8);
      --surface-glass: rgba(255, 255, 255, 0.72);
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #a1a1a6;
      --border: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.12);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* Layout */
      --header-height: 60px;
      --sidebar-width: 280px;
      --max-width: 1200px;
    }

    /* Dark Theme */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #000000;
        --background-secondary: #1c1c1e;
        --background-tertiary: #2c2c2e;
        --surface: #1c1c1e;
        --surface-secondary: rgba(28, 28, 30, 0.8);
        --surface-glass: rgba(28, 28, 30, 0.72);
        --text-primary: #f2f2f7;
        --text-secondary: #8e8e93;
        --text-tertiary: #636366;
        --border: rgba(255, 255, 255, 0.08);
        --border-strong: rgba(255, 255, 255, 0.12);
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      }
    }

    /* Reset & Base Styles */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: var(--font-system);
      background-color: var(--background);
      color: var(--text-primary);
      font-feature-settings: 'rlig' 1, 'calt' 1;
      min-height: 100vh;
      transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Typography Scale */
    .text-xs {
      font-size: 0.75rem;
      line-height: 1rem;
    }

    .text-sm {
      font-size: 0.875rem;
      line-height: 1.25rem;
    }

    .text-base {
      font-size: 1rem;
      line-height: 1.5rem;
    }

    .text-lg {
      font-size: 1.125rem;
      line-height: 1.75rem;
    }

    .text-xl {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }

    .text-2xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }

    .text-3xl {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }

    .text-4xl {
      font-size: 2.25rem;
      line-height: 2.5rem;
    }

    .text-5xl {
      font-size: 3rem;
      line-height: 1;
    }

    /* Font Weights */
    .font-light {
      font-weight: 300;
    }

    .font-normal {
      font-weight: 400;
    }

    .font-medium {
      font-weight: 500;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-bold {
      font-weight: 700;
    }

    .font-extrabold {
      font-weight: 800;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      grid-template-columns: var(--sidebar-width) 1fr;
      grid-template-rows: var(--header-height) 1fr;
      min-height: 100vh;
    }

    @media (max-width: 1024px) {
      .app {
        grid-template-areas:
          "header"
          "main";
        grid-template-columns: 1fr;
        grid-template-rows: var(--header-height) 1fr;
      }
    }

    /* Header */
    .header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
      background: var(--surface-glass);
      backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--blue-500) 0%, var(--purple-500) 100%);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-semibold);
      font-size: 0.875rem;
      box-shadow: var(--shadow);
    }

    .brand-text {
      font-weight: 600;
      font-size: 1.125rem;
      letter-spacing: -0.025em;
    }

    .brand-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: -2px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: 0.875rem;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--blue-500) 0%, var(--purple-500) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: transform 0.15s ease;
      border: 2px solid transparent;
    }

    .user-avatar:hover {
      transform: scale(1.05);
      border-color: var(--blue-500);
    }

    .user-avatar.has-image {
      background: none;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Menu Button (Mobile) */
    .menu-button {
      display: none;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: none;
      background: none;
      color: var(--text-primary);
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: background-color 0.15s ease;
    }

    .menu-button:hover {
      background-color: var(--background-secondary);
    }

    @media (max-width: 1024px) {
      .menu-button {
        display: flex;
      }
    }

    /* Sidebar */
    .sidebar {
      grid-area: sidebar;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: var(--space-6);
      overflow-y: auto;
      position: relative;
    }

    @media (max-width: 1024px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: min(320px, 85vw);
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-xl);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 45;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .sidebar-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
    }

    /* Navigation */
    .nav-section {
      margin-bottom: var(--space-8);
    }

    .nav-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s ease;
      cursor: pointer;
      min-height: 44px;
      margin-bottom: var(--space-1);
    }

    .nav-item:hover {
      background-color: var(--background-secondary);
    }

    .nav-item.active {
      background-color: var(--blue-500);
      color: white;
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* Profile section in sidebar */
    .nav-profile-section {
      position: absolute;
      bottom: var(--space-6);
      left: var(--space-6);
      right: var(--space-6);
      border-top: 1px solid var(--border);
      padding-top: var(--space-4);
    }

    /* Main Content */
    .main {
      grid-area: main;
      padding: var(--space-8);
      max-width: var(--max-width);
      margin: 0 auto;
      width: 100%;
    }

    @media (max-width: 768px) {
      .main {
        padding: var(--space-6);
      }
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-6);
    }

    .surface {
      background: var(--background-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
    }

    /* Glass Effect */
    .glass {
      background: var(--surface-glass);
      backdrop-filter: saturate(180%) blur(20px);
      border: 1px solid var(--border);
    }

    /* Grid System */
    .grid {
      display: grid;
      gap: var(--space-6);
      grid-template-columns: repeat(12, 1fr);
    }

    .col-span-1 {
      grid-column: span 1;
    }

    .col-span-2 {
      grid-column: span 2;
    }

    .col-span-3 {
      grid-column: span 3;
    }

    .col-span-4 {
      grid-column: span 4;
    }

    .col-span-6 {
      grid-column: span 6;
    }

    .col-span-8 {
      grid-column: span 8;
    }

    .col-span-12 {
      grid-column: span 12;
    }

    @media (max-width: 1024px) {

      .col-span-3,
      .col-span-4,
      .col-span-6,
      .col-span-8 {
        grid-column: span 12;
      }
    }

    @media (max-width: 768px) {
      .grid {
        gap: var(--space-4);
      }
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      font-size: 0.875rem;
      font-weight: 600;
      line-height: 1;
      border: none;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      min-height: 44px;
      position: relative;
      overflow: hidden;
    }

    .btn:focus-visible {
      outline: 2px solid var(--blue-500);
      outline-offset: 2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--background-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--background-tertiary);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--green-500) 0%, var(--green-600) 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--red-500) 0%, var(--red-600) 100%);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: var(--space-6);
    }

    .label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .input {
      width: 100%;
      padding: var(--space-4);
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      color: var(--text-primary);
      transition: all 0.15s ease;
      min-height: 44px;
    }

    .input:focus {
      outline: none;
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .input::placeholder {
      color: var(--text-tertiary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: var(--background-secondary);
      border-radius: var(--radius-md);
      padding: var(--space-1);
      margin-bottom: var(--space-6);
    }

    .tab {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      text-align: center;
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--text-secondary);
      background: none;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab.active {
      background: white;
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }

    /* Stats */
    .stat {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, var(--blue-500) 0%, var(--purple-500) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      box-shadow: var(--shadow);
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }

    /* Progress */
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--background-secondary);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green-500) 0%, var(--blue-500) 100%);
      border-radius: var(--radius-full);
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        left: -100%;
      }

      100% {
        left: 100%;
      }
    }

    /* Circular Progress */
    .circular-progress {
      position: relative;
      width: 140px;
      height: 140px;
      margin: 0 auto;
    }

    .circular-progress svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-circle {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
    }

    .progress-bg {
      stroke: var(--background-secondary);
    }

    .progress-fg {
      stroke: url(#gradient);
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
    }

    /* Chart */
    .chart {
      position: relative;
      width: 100%;
      height: 200px;
      background: var(--background-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .chart-gridlines {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(to top,
          var(--border) 0,
          var(--border) 1px,
          transparent 1px,
          transparent 40px);
      pointer-events: none;
    }

    .chart-bar {
      position: absolute;
      bottom: var(--space-3);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      background: linear-gradient(135deg, var(--green-500) 0%, var(--blue-500) 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    .chart-bar:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* Modals */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-6);
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    /* Profile Modal Specific Styles */
    .profile-section {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      padding: var(--space-4);
      background: var(--background-secondary);
      border-radius: var(--radius-lg);
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--blue-500) 0%, var(--purple-500) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.25rem;
      overflow: hidden;
    }

    .profile-avatar.has-image {
      background: none;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info h3 {
      margin-bottom: var(--space-1);
    }

    .profile-info p {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .cropper-container {
      margin: var(--space-4) 0;
      max-height: 300px;
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .profile-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-6);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: var(--space-6);
      right: var(--space-6);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-6);
      box-shadow: var(--shadow-lg);
      z-index: 70;
      font-weight: 500;
      transform: translateY(-100px);
      opacity: 0;
      animation: toast-in 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes toast-in {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Utilities */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .hidden {
      display: none !important;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--blue-500);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Responsive Design */
    @media (max-width: 640px) {
      .main {
        padding: var(--space-4);
      }

      .card {
        padding: var(--space-6);
      }

      .grid {
        gap: var(--space-4);
      }

      .modal-content {
        padding: var(--space-6);
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <nav>
        <div class="nav-section">
          <h3 class="nav-title">Navigation</h3>
          <a href="#" class="nav-item active" id="nav-dashboard">
            <span class="nav-icon">üè†</span>
            Dashboard
          </a>
          <a href="#" class="nav-item" id="nav-setup">
            <span class="nav-icon">‚öôÔ∏è</span>
            Setup
          </a>
        </div>

        <div class="nav-section" id="nav-actions">
          <h3 class="nav-title">Actions</h3>
          <a href="#" class="nav-item" id="nav-history">
            <span class="nav-icon">üìä</span>
            History
          </a>
          <a href="#" class="nav-item" id="nav-export-pdf">
            <span class="nav-icon">üìÑ</span>
            Export PDF
          </a>
          <a href="#" class="nav-item" id="nav-export">
            <span class="nav-icon">üíæ</span>
            Export Data
          </a>
          <a href="#" class="nav-item" id="nav-import">
            <span class="nav-icon">üìÅ</span>
            Import Data
          </a>
          <a href="#" class="nav-item" id="nav-reset">
            <span class="nav-icon">‚ôªÔ∏è</span>
            Reset Data
          </a>
        </div>

        <div class="nav-section nav-profile-section" id="nav-profile-section">
          <h3 class="nav-title">Profile</h3>
          <a href="#" class="nav-item" id="sidebar-profile-btn">
            <span class="nav-icon">üë§</span>
            Profile Settings
          </a>
          <a href="#" class="nav-item" id="nav-logout">
            <span class="nav-icon">üö™</span>
            Logout
          </a>
        </div>
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Header -->
    <header class="header">
      <button class="menu-button" id="menu-button">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
            clip-rule="evenodd" />
        </svg>
        <span class="sr-only">Open menu</span>
      </button>

      <div class="brand">
        <div class="logo">üìö</div>
        <div>
          <div class="brand-text">Backlog Tracker</div>
          <div class="brand-subtitle">instant sync</div>
        </div>
      </div>

      <div class="header-actions">
        <!-- Login Button (shown when guest) -->
        <button class="btn btn-primary" id="login-button">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 4px;">
            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
          </svg>
          Login
        </button>

        <!-- User Avatar (shown when logged in) -->
        <div class="user-info hidden" id="user-info">
          <div class="user-avatar" id="user-avatar">G</div>
        </div>
      </div>
    </header>

    <!-- Auth Modal -->
    <div class="modal" id="auth-modal">
      <div class="modal-content">
        <div style="margin-bottom: var(--space-6);">
          <h2 class="text-2xl font-bold" style="margin-bottom: var(--space-2);">Welcome</h2>
          <p class="text-base" style="color: var(--text-secondary);">
            Sign in to sync your progress across devices
          </p>
        </div>

        <div class="tabs" id="auth-tabs">
          <button class="tab active" data-tab="login">Sign In</button>
          <button class="tab" data-tab="signup">Sign Up</button>
          <button class="tab" data-tab="reset">Reset</button>
        </div>

        <!-- Login Tab -->
        <div id="login-tab" class="tab-content">
          <div class="form-group">
            <label class="label" for="login-email">Email</label>
            <input type="email" id="login-email" class="input" placeholder="your@email.com" autocomplete="username">
          </div>

          <div class="form-group">
            <label class="label" for="login-password">Password</label>
            <input type="password" id="login-password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autocomplete="current-password">
          </div>

          <button class="btn btn-primary" id="login-submit" style="width: 100%; margin-bottom: var(--space-4);">
            <span id="login-text">Sign In</span>
            <span class="loading hidden" id="login-loading"></span>
          </button>

          <button class="btn btn-secondary" id="close-auth-modal" style="width: 100%;">
            Continue as Guest
          </button>
        </div>

        <!-- Signup Tab -->
        <div id="signup-tab" class="tab-content hidden">
          <div class="form-group">
            <label class="label" for="signup-name">Name (optional)</label>
            <input type="text" id="signup-name" class="input" placeholder="Your full name">
          </div>

          <div class="form-group">
            <label class="label" for="signup-email">Email</label>
            <input type="email" id="signup-email" class="input" placeholder="your@email.com" autocomplete="username">
          </div>

          <div class="form-group">
            <label class="label" for="signup-password">Password</label>
            <input type="password" id="signup-password" class="input" placeholder="At least 6 characters"
              autocomplete="new-password">
          </div>

          <button class="btn btn-primary" id="signup-submit" style="width: 100%; margin-bottom: var(--space-4);">
            <span id="signup-text">Create Account</span>
            <span class="loading hidden" id="signup-loading"></span>
          </button>

          <button class="btn btn-secondary" id="close-auth-modal-2" style="width: 100%;">
            Continue as Guest
          </button>
        </div>

        <!-- Reset Tab -->
        <div id="reset-tab" class="tab-content hidden">
          <div class="form-group">
            <label class="label" for="reset-email">Email</label>
            <input type="email" id="reset-email" class="input" placeholder="your@email.com" autocomplete="username">
          </div>

          <button class="btn btn-primary" id="reset-submit" style="width: 100%; margin-bottom: var(--space-4);">
            <span id="reset-text">Send Reset Link</span>
            <span class="loading hidden" id="reset-loading"></span>
          </button>

          <button class="btn btn-secondary" id="close-auth-modal-3" style="width: 100%;">
            Continue as Guest
          </button>
        </div>
      </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profile-modal">
      <div class="modal-content">
        <h2 class="text-2xl font-bold" style="margin-bottom: var(--space-6);">Profile Settings</h2>
        
        <!-- Profile Section -->
        <div class="profile-section">
          <div class="profile-avatar" id="profile-modal-avatar">G</div>
          <div class="profile-info">
            <h3 class="text-lg font-semibold" id="profile-name">Guest User</h3>
            <p id="profile-email">guest@example.com</p>
            <p id="profile-joined">Joined: Today</p>
          </div>
        </div>

        <!-- Profile Picture Upload -->
        <div class="form-group">
          <label class="label">Profile Picture</label>
          <input type="file" id="profile-picture-input" class="input" accept="image/*">
          <div id="cropper-container" class="cropper-container hidden">
            <img id="cropper-image" style="max-width: 100%;">
          </div>
        </div>

        <!-- Profile Actions -->
        <div class="profile-actions">
          <button class="btn btn-primary hidden" id="save-profile-picture">Save Picture</button>
          <button class="btn btn-danger" id="profile-logout-btn">Log Out</button>
          <button class="btn btn-secondary" id="close-profile-modal">Close</button>
        </div>
      </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal" id="setup-modal">
      <div class="modal-content">
        <div style="margin-bottom: var(--space-6);">
          <h2 class="text-2xl font-bold" style="margin-bottom: var(--space-2);">Setup</h2>
          <p class="text-base" style="color: var(--text-secondary);">
            Let's get you started with tracking your lecture backlog
          </p>
        </div>

        <div class="form-group">
          <label class="label" for="setup-name">Your Name (optional)</label>
          <input type="text" id="setup-name" class="input" placeholder="Enter your name">
        </div>

        <div class="form-group">
          <label class="label" for="setup-initial">Initial Backlog Count</label>
          <input type="number" id="setup-initial" class="input" placeholder="How many lectures are you behind?" min="0">
        </div>

        <button class="btn btn-success" id="complete-setup" style="width: 100%;">
          Start Tracking
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main">
      <!-- Dashboard -->
      <section id="dashboard-view" class="animate-in">
        <div style="margin-bottom: var(--space-8);">
          <h1 class="text-3xl font-bold" style="margin-bottom: var(--space-2);">Dashboard</h1>
          <p class="text-lg" style="color: var(--text-secondary);" id="welcome-message">
            Welcome back! Track your lecture progress with precision.
          </p>
        </div>

        <!-- Stats Grid -->
        <div class="grid" style="margin-bottom: var(--space-8);">
          <div class="col-span-3">
            <div class="surface">
              <div class="stat">
                <div class="stat-icon">üìö</div>
                <div class="stat-content">
                  <div class="stat-label">Total Backlogs</div>
                  <div class="stat-value" id="stat-total">0</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-span-3">
            <div class="surface">
              <div class="stat">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                  <div class="stat-label">Completed</div>
                  <div class="stat-value" id="stat-completed">0</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-span-3">
            <div class="surface">
              <div class="stat">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                  <div class="stat-label">Remaining</div>
                  <div class="stat-value" id="stat-remaining">0</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-span-3">
            <div class="surface">
              <div class="stat">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                  <div class="stat-label">Daily Average</div>
                  <div class="stat-value" id="stat-average">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div class="grid">
          <div class="col-span-8">
            <div class="card">
              <div class="progress-header">
                <h3 class="text-xl font-semibold">Overall Progress</h3>
                <span class="text-2xl font-bold" id="progress-percentage">0%</span>
              </div>

              <div class="progress-bar" style="margin-bottom: var(--space-8);">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
              </div>

              <div style="display: flex; justify-content: center;">
                <div class="circular-progress">
                  <svg viewBox="0 0 160 160">
                    <defs>
                      <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color: var(--green-500)" />
                        <stop offset="100%" style="stop-color: var(--blue-500)" />
                      </linearGradient>
                    </defs>
                    <circle class="progress-circle progress-bg" cx="80" cy="80" r="70"></circle>
                    <circle class="progress-circle progress-fg" cx="80" cy="80" r="70" id="circular-progress"></circle>
                  </svg>
                  <div class="progress-text" id="circular-progress-text">0%</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-span-4">
            <div class="card">
              <h3 class="text-xl font-semibold" style="margin-bottom: var(--space-6);">Quick Log</h3>

              <div class="form-group">
                <label class="label" for="log-date">Date</label>
                <input type="date" id="log-date" class="input">
              </div>

              <div class="form-group">
                <label class="label" for="lectures-completed">Lectures Completed</label>
                <input type="number" id="lectures-completed" class="input" placeholder="0" min="0">
              </div>

              <div class="form-group">
                <label class="label" for="new-lectures">New Lectures Added</label>
                <input type="number" id="new-lectures" class="input" placeholder="0" min="0">
              </div>

              <div style="display: flex; gap: var(--space-3); margin-bottom: var(--space-4);">
                <button class="btn btn-primary" id="save-entry">Save Entry</button>
                <button class="btn btn-secondary" id="set-today">Today</button>
              </div>

              <p class="text-sm" style="color: var(--text-secondary);">
                Entries for the same date will be updated.
              </p>
            </div>
          </div>
        </div>

        <!-- Weekly Chart -->
        <div class="card">
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
            <h3 class="text-xl font-semibold">Weekly Progress</h3>
            <span class="text-sm" style="color: var(--text-secondary);" id="chart-range">Last 7 entries</span>
          </div>

          <div class="chart" id="weekly-chart">
            <div class="chart-gridlines"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
      authDomain: "aspirehub-32863.firebaseapp.com",
      projectId: "aspirehub-32863",
      storageBucket: "aspirehub-32863.appspot.com",
      messagingSenderId: "686810111182",
      appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
      measurementId: "G-KX41R0SSMY",
      databaseURL: "https://aspirehub-32863-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence({ synchronizeTabs: true }).catch(() => {
      console.log('Persistence failed');
    });

    // App state
    let currentUser = null;
    let appData = {
      userName: '',
      initialBacklogs: 0,
      dailyEntries: [],
      totalCompleted: 0,
      setupComplete: false,
      profilePicture: null,
      updatedAt: null
    };

    // Real-time listener
    let unsubscribeListener = null;
    let isUpdatingFromRemote = false;

    // Cropper instance
    let cropper = null;

    // Touch/Swipe variables
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isSwiping = false;

    // DOM elements
    const menuButton = document.getElementById('menu-button');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const loginButton = document.getElementById('login-button');
    const userInfo = document.getElementById('user-info');
    const userAvatar = document.getElementById('user-avatar');
    const welcomeMessage = document.getElementById('welcome-message');

    // Auth modal elements
    const authModal = document.getElementById('auth-modal');
    const authTabs = document.getElementById('auth-tabs');
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const resetTab = document.getElementById('reset-tab');

    // Profile modal elements
    const profileModal = document.getElementById('profile-modal');
    const profileModalAvatar = document.getElementById('profile-modal-avatar');
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    const profileJoined = document.getElementById('profile-joined');
    const profilePictureInput = document.getElementById('profile-picture-input');
    const cropperContainer = document.getElementById('cropper-container');
    const cropperImage = document.getElementById('cropper-image');
    const saveProfilePictureBtn = document.getElementById('save-profile-picture');
    const profileLogoutBtn = document.getElementById('profile-logout-btn');
    const closeProfileModalBtn = document.getElementById('close-profile-modal');

    // Setup modal elements
    const setupModal = document.getElementById('setup-modal');
    const setupName = document.getElementById('setup-name');
    const setupInitial = document.getElementById('setup-initial');
    const completeSetupBtn = document.getElementById('complete-setup');

    // Form elements
    const logDate = document.getElementById('log-date');
    const lecturesCompleted = document.getElementById('lectures-completed');
    const newLectures = document.getElementById('new-lectures');
    const saveEntryBtn = document.getElementById('save-entry');
    const setTodayBtn = document.getElementById('set-today');

    // Navigation elements
    const navActions = document.getElementById('nav-actions');
    const navProfileSection = document.getElementById('nav-profile-section');
    const sidebarProfileBtn = document.getElementById('sidebar-profile-btn');

    // Touch/Swipe functions
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches.clientY;
      
      // Only start tracking if touch starts from left edge (within 50px from left)
      if (touchStartX <= 50 && window.innerWidth > 1024) {
        return; // Don't handle swipe on desktop
      }
      
      if (touchStartX <= 50) {
        isSwiping = true;
      }
    }

    function handleTouchMove(e) {
      if (!isSwiping) return;
      
      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches.clientY;
      
      // Prevent default scrolling if we're swiping horizontally
      const deltaX = Math.abs(touchEndX - touchStartX);
      const deltaY = Math.abs(touchEndY - touchStartY);
      
      if (deltaX > deltaY && deltaX > 20) {
        e.preventDefault();
      }
    }

    function handleTouchEnd(e) {
      if (!isSwiping) return;
      
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const minSwipeDistance = 80;
      
      // Check if it's a valid left-to-right swipe
      if (deltaX > minSwipeDistance && Math.abs(deltaY) < 100) {
        // Only open sidebar if it's currently closed
        if (!sidebar.classList.contains('open')) {
          sidebar.classList.add('open');
          sidebarOverlay.classList.add('active');
        }
      }
      
      // Reset swipe tracking
      isSwiping = false;
      touchStartX = 0;
      touchStartY = 0;
      touchEndX = 0;
      touchEndY = 0;
    }

    // Utility functions
    function safeString(val, fallback = '') {
      if (val === null || val === undefined) return fallback;
      return String(val);
    }

    function safeNumber(val, fallback = 0) {
      const num = Number(val);
      return isNaN(num) ? fallback : num;
    }

    function toast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;

      if (type === 'error') {
        toast.style.background = 'var(--red-500)';
        toast.style.color = 'white';
      } else if (type === 'success') {
        toast.style.background = 'var(--green-500)';
        toast.style.color = 'white';
      }

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function formatDate(date) {
      return new Date(date).toISOString().split('T')[0];
    }

    function setToday() {
      logDate.value = formatDate(new Date());
    }

    function getStorageKey() {
      return currentUser ? `lectureBacklog_${currentUser.uid}` : 'lectureBacklog_guest';
    }

    function getUserDisplayName() {
      if (currentUser && appData.userName) {
        return appData.userName;
      } else if (currentUser && currentUser.email) {
        return currentUser.email.split('@')[0];
      }
      return 'Guest';
    }

    function updateUserAvatar() {
      const displayName = getUserDisplayName();
      const firstLetter = displayName.charAt(0).toUpperCase();
      
      // Update header avatar
      if (appData.profilePicture) {
        userAvatar.innerHTML = `<img src="${appData.profilePicture}" alt="Profile">`;
        userAvatar.classList.add('has-image');
      } else {
        userAvatar.textContent = firstLetter;
        userAvatar.classList.remove('has-image');
      }

      // Update profile modal avatar
      if (appData.profilePicture) {
        profileModalAvatar.innerHTML = `<img src="${appData.profilePicture}" alt="Profile">`;
        profileModalAvatar.classList.add('has-image');
      } else {
        profileModalAvatar.textContent = firstLetter;
        profileModalAvatar.classList.remove('has-image');
      }
    }

    function updateProfileModal() {
      const displayName = getUserDisplayName();
      const email = currentUser ? currentUser.email : 'guest@example.com';
      const joinedDate = currentUser && currentUser.metadata.creationTime 
        ? new Date(currentUser.metadata.creationTime).toLocaleDateString()
        : 'Today';

      profileName.textContent = displayName;
      profileEmail.textContent = email;
      profileJoined.textContent = `Joined: ${joinedDate}`;
      
      updateUserAvatar();
    }

    // Real-time sync functions
    function setupRealtimeListener() {
      if (!currentUser || unsubscribeListener) return;

      const docRef = db.collection('lectureBacklogs').doc(currentUser.uid);
      
      unsubscribeListener = docRef.onSnapshot((doc) => {
        if (doc.exists && !isUpdatingFromRemote) {
          const remoteData = doc.data();
          
          // Check if remote data is newer
          if (remoteData.updatedAt && (!appData.updatedAt || new Date(remoteData.updatedAt) > new Date(appData.updatedAt))) {
            console.log('Updating from remote data...');
            isUpdatingFromRemote = true;
            
            // Merge remote data with local
            const oldEntryCount = appData.dailyEntries.length;
            appData = { ...appData, ...remoteData };
            
            // Save to local storage
            saveLocalData();
            
            // Update UI
            updateUI();
            
            // Show notification if new data was synced
            const newEntryCount = appData.dailyEntries.length;
            if (newEntryCount > oldEntryCount) {
              toast(`Synced ${newEntryCount - oldEntryCount} new entries from another device!`, 'success');
            } else if (remoteData.updatedAt !== appData.updatedAt) {
              toast('Data synced from another device!', 'success');
            }
            
            isUpdatingFromRemote = false;
          }
        }
      }, (error) => {
        console.error('Real-time listener error:', error);
      });
    }

    function removeRealtimeListener() {
      if (unsubscribeListener) {
        unsubscribeListener();
        unsubscribeListener = null;
      }
    }

    // Initialize app
    function initializeApp() {
      setToday();
      loadLocalData();
      updateUI();
      setupEventListeners();

      // Check if setup is needed
      if (!appData.setupComplete) {
        showSetupModal();
      }
    }

    function setupEventListeners() {
      // Touch/swipe events
      document.addEventListener('touchstart', handleTouchStart, { passive: false });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', handleTouchEnd);

      // Mobile menu
      menuButton.addEventListener('click', toggleSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);

      // Login button
      loginButton.addEventListener('click', showAuthModal);

      // Profile buttons
      userAvatar.addEventListener('click', showProfileModal);
      sidebarProfileBtn.addEventListener('click', showProfileModal);
      closeProfileModalBtn.addEventListener('click', closeProfileModal);
      profileLogoutBtn.addEventListener('click', logout);

      // Profile picture upload
      profilePictureInput.addEventListener('change', handleProfilePictureUpload);
      saveProfilePictureBtn.addEventListener('click', saveProfilePicture);

      // Auth modal tabs
      authTabs.addEventListener('click', handleAuthTabClick);

      // Auth form submissions
      document.getElementById('login-submit').addEventListener('click', handleLogin);
      document.getElementById('signup-submit').addEventListener('click', handleSignup);
      document.getElementById('reset-submit').addEventListener('click', handlePasswordReset);

      // Close auth modal buttons
      document.getElementById('close-auth-modal').addEventListener('click', closeAuthModal);
      document.getElementById('close-auth-modal-2').addEventListener('click', closeAuthModal);
      document.getElementById('close-auth-modal-3').addEventListener('click', closeAuthModal);

      // Setup
      completeSetupBtn.addEventListener('click', completeSetup);

      // Quick log
      setTodayBtn.addEventListener('click', setToday);
      saveEntryBtn.addEventListener('click', saveEntry);

      // Navigation
      document.getElementById('nav-logout').addEventListener('click', logout);

      // Auth state listener
      auth.onAuthStateChanged(handleAuthStateChange);

      // Enter key submissions
      document.getElementById('login-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      document.getElementById('signup-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSignup();
      });
      document.getElementById('reset-email').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handlePasswordReset();
      });
    }

    // Profile picture handling
    function handleProfilePictureUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        toast('Please select an image file', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        cropperImage.src = e.target.result;
        cropperContainer.classList.remove('hidden');
        saveProfilePictureBtn.classList.remove('hidden');

        // Destroy existing cropper if any
        if (cropper) {
          cropper.destroy();
        }

        // Initialize cropper
        cropper = new Cropper(cropperImage, {
          aspectRatio: 1,
          viewMode: 1,
          guides: false,
          center: false,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
        });
      };
      reader.readAsDataURL(file);
    }

    function saveProfilePicture() {
      if (!cropper) return;

      const canvas = cropper.getCroppedCanvas({
        width: 200,
        height: 200,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });

      const croppedImage = canvas.toDataURL('image/jpeg', 0.8);
      appData.profilePicture = croppedImage;
      appData.updatedAt = new Date().toISOString();

      // Update UI
      updateUserAvatar();
      
      // Hide cropper
      cropperContainer.classList.add('hidden');
      saveProfilePictureBtn.classList.add('hidden');
      profilePictureInput.value = '';

      // Destroy cropper
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      // Save data
      saveLocalData();
      if (currentUser) {
        syncToFirestore();
      }

      toast('Profile picture updated successfully!');
    }

    // UI Management
    function updateAuthUI() {
      if (currentUser) {
        // User is logged in
        loginButton.classList.add('hidden');
        userInfo.classList.remove('hidden');
        navActions.style.display = 'block';
        navProfileSection.style.display = 'block';

        const displayName = getUserDisplayName();
        welcomeMessage.textContent = `Welcome back, ${displayName}!`;
        updateUserAvatar();
        updateProfileModal();
      } else {
        // User is guest
        loginButton.classList.remove('hidden');
        userInfo.classList.add('hidden');
        navActions.style.display = 'block';
        navProfileSection.style.display = 'none';

        welcomeMessage.textContent = 'Welcome! Track your lecture progress with precision.';
        updateUserAvatar();
        updateProfileModal();
      }
    }

    function toggleSidebar() {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('active');
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
    }

    function showAuthModal() {
      authModal.classList.add('active');
    }

    function closeAuthModal() {
      authModal.classList.remove('active');
    }

    function showProfileModal() {
      updateProfileModal();
      profileModal.classList.add('active');
      closeSidebar(); // Close sidebar on mobile when opening profile
    }

    function closeProfileModal() {
      profileModal.classList.remove('active');
      
      // Clean up cropper
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      cropperContainer.classList.add('hidden');
      saveProfilePictureBtn.classList.add('hidden');
      profilePictureInput.value = '';
    }

    function showSetupModal() {
      setupModal.classList.add('active');
    }

    function closeSetupModal() {
      setupModal.classList.remove('active');
    }

    function handleAuthTabClick(e) {
      if (!e.target.classList.contains('tab')) return;

      // Update tab states
      authTabs.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      e.target.classList.add('active');

      // Show corresponding content
      const tabName = e.target.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
    }

    // Authentication functions
    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        toast('Please enter both email and password', 'error');
        return;
      }

      const loadingElement = document.getElementById('login-loading');
      const textElement = document.getElementById('login-text');

      loadingElement.classList.remove('hidden');
      textElement.textContent = 'Signing in...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        toast('Successfully signed in!');
        closeAuthModal();
      } catch (error) {
        toast(error.message, 'error');
      } finally {
        loadingElement.classList.add('hidden');
        textElement.textContent = 'Sign In';
      }
    }

    async function handleSignup() {
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;

      if (!email || !password) {
        toast('Please enter both email and password', 'error');
        return;
      }

      if (password.length < 6) {
        toast('Password must be at least 6 characters', 'error');
        return;
      }

      const loadingElement = document.getElementById('signup-loading');
      const textElement = document.getElementById('signup-text');

      loadingElement.classList.remove('hidden');
      textElement.textContent = 'Creating account...';

      try {
        const result = await auth.createUserWithEmailAndPassword(email, password);

        // Update app data with user name
        if (name) {
          appData.userName = name;
          appData.updatedAt = new Date().toISOString();
        }

        toast('Account created successfully!');
        closeAuthModal();

        if (!appData.setupComplete) {
          showSetupModal();
        }
      } catch (error) {
        toast(error.message, 'error');
      } finally {
        loadingElement.classList.add('hidden');
        textElement.textContent = 'Create Account';
      }
    }

    async function handlePasswordReset() {
      const email = document.getElementById('reset-email').value.trim();

      if (!email) {
        toast('Please enter your email address', 'error');
        return;
      }

      const loadingElement = document.getElementById('reset-loading');
      const textElement = document.getElementById('reset-text');

      loadingElement.classList.remove('hidden');
      textElement.textContent = 'Sending...';

      try {
        await auth.sendPasswordResetEmail(email);
        toast('Password reset email sent! Check your inbox.');
        closeAuthModal();
      } catch (error) {
        toast(error.message, 'error');
      } finally {
        loadingElement.classList.add('hidden');
        textElement.textContent = 'Send Reset Link';
      }
    }

    async function logout() {
      try {
        await auth.signOut();
        closeProfileModal();
        toast('Successfully logged out');
      } catch (error) {
        toast('Error logging out', 'error');
      }
    }

    async function completeSetup() {
      const name = setupName.value.trim();
      const initialCount = parseInt(setupInitial.value) || 0;

      appData.userName = name || appData.userName || 'Student';
      appData.initialBacklogs = initialCount;
      appData.setupComplete = true;
      appData.updatedAt = new Date().toISOString();

      saveLocalData();

      if (currentUser) {
        await syncToFirestore();
      }

      updateUI();
      closeSetupModal();
      toast('Setup completed successfully!');
    }

    function saveEntry() {
      const date = logDate.value;
      const completed = parseInt(lecturesCompleted.value) || 0;
      const newLecs = parseInt(newLectures.value) || 0;

      if (!date) {
        toast('Please select a date', 'error');
        return;
      }

      // Find existing entry or create new one
      const existingIndex = appData.dailyEntries.findIndex(entry => entry.date === date);
      const entry = {
        date,
        completed,
        newLectures: newLecs,
        timestamp: new Date().toISOString()
      };

      if (existingIndex >= 0) {
        appData.dailyEntries[existingIndex] = entry;
      } else {
        appData.dailyEntries.push(entry);
      }

      // Sort entries by date
      appData.dailyEntries.sort((a, b) => a.date.localeCompare(b.date));

      // Update total completed
      appData.totalCompleted = appData.dailyEntries.reduce((sum, entry) => sum + entry.completed, 0);
      appData.updatedAt = new Date().toISOString();

      // Save and update UI
      saveLocalData();
      if (currentUser) {
        syncToFirestore();
      }
      updateUI();

      // Clear form
      lecturesCompleted.value = '';
      newLectures.value = '';

      toast('Entry saved successfully!');
    }

    function updateUI() {
      updateStats();
      updateProgress();
      renderWeeklyChart();
      updateAuthUI();
    }

    function updateStats() {
      const totalNewLectures = appData.dailyEntries.reduce((sum, entry) => sum + safeNumber(entry.newLectures), 0);
      const totalBacklogs = safeNumber(appData.initialBacklogs) + totalNewLectures;
      const completed = appData.dailyEntries.reduce((sum, entry) => sum + safeNumber(entry.completed), 0);
      const remaining = Math.max(0, totalBacklogs - completed);
      const average = appData.dailyEntries.length > 0 ? (completed / appData.dailyEntries.length).toFixed(1) : '0.0';

      document.getElementById('stat-total').textContent = totalBacklogs;
      document.getElementById('stat-completed').textContent = completed;
      document.getElementById('stat-remaining').textContent = remaining;
      document.getElementById('stat-average').textContent = average;
    }

    function updateProgress() {
      const totalNewLectures = appData.dailyEntries.reduce((sum, entry) => sum + safeNumber(entry.newLectures), 0);
      const totalBacklogs = safeNumber(appData.initialBacklogs) + totalNewLectures;
      const completed = appData.dailyEntries.reduce((sum, entry) => sum + safeNumber(entry.completed), 0);
      const percentage = totalBacklogs > 0 ? Math.round((completed / totalBacklogs) * 100) : 0;

      document.getElementById('progress-percentage').textContent = `${percentage}%`;
      document.getElementById('progress-fill').style.width = `${percentage}%`;
      document.getElementById('circular-progress-text').textContent = `${percentage}%`;

      // Update circular progress
      const circumference = 2 * Math.PI * 70;
      const offset = circumference - (percentage / 100) * circumference;
      document.getElementById('circular-progress').style.strokeDashoffset = offset;
    }

    function renderWeeklyChart() {
      const chart = document.getElementById('weekly-chart');
      const bars = chart.querySelectorAll('.chart-bar');
      bars.forEach(bar => bar.remove());

      const lastWeek = appData.dailyEntries.slice(-7);
      if (lastWeek.length === 0) return;

      const maxValue = Math.max(...lastWeek.map(entry => safeNumber(entry.completed)), 1);
      const chartWidth = chart.offsetWidth;
      const barWidth = Math.max(20, (chartWidth - 60) / lastWeek.length);

      lastWeek.forEach((entry, index) => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.left = `${30 + index * (barWidth + 10)}px`;
        bar.style.width = `${barWidth}px`;
        bar.style.height = `${(safeNumber(entry.completed) / maxValue) * 140}px`;
        bar.title = `${entry.date}: ${entry.completed} lectures`;
        chart.appendChild(bar);
      });

      const range = lastWeek.length > 0 ?
        `${lastWeek[0].date} ‚Üí ${lastWeek[lastWeek.length - 1].date}` :
        'No data';
      document.getElementById('chart-range').textContent = range;
    }

    function loadLocalData() {
      const stored = localStorage.getItem(getStorageKey());
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          appData = { ...appData, ...parsed };
        } catch (e) {
          console.error('Error parsing stored data:', e);
        }
      }
    }

    function saveLocalData() {
      localStorage.setItem(getStorageKey(), JSON.stringify(appData));
    }

    async function syncToFirestore() {
      if (!currentUser || isUpdatingFromRemote) return;

      try {
        const docRef = db.collection('lectureBacklogs').doc(currentUser.uid);
        await docRef.set(appData, { merge: true });
        console.log('Data synced to Firestore');
      } catch (error) {
        console.error('Error syncing to Firestore:', error);
        toast('Sync failed. Will retry when online.', 'error');
      }
    }

    async function loadFromFirestore() {
      if (!currentUser) return;

      try {
        const docRef = db.collection('lectureBacklogs').doc(currentUser.uid);
        const doc = await docRef.get();

        if (doc.exists) {
          const remoteData = doc.data();
          
          // Simple merge strategy: use remote if it's newer
          if (remoteData.updatedAt && (!appData.updatedAt || new Date(remoteData.updatedAt) > new Date(appData.updatedAt))) {
            // Merge guest data with remote data if user just signed in
            if (appData.dailyEntries.length > 0) {
              // If guest has data, merge it
              const guestEntries = appData.dailyEntries;
              appData = { ...appData, ...remoteData };

              // Merge daily entries
              const entryMap = new Map();
              [...remoteData.dailyEntries, ...guestEntries].forEach(entry => {
                entryMap.set(entry.date, entry);
              });
              appData.dailyEntries = Array.from(entryMap.values()).sort((a, b) => a.date.localeCompare(b.date));

              // Update totals
              appData.totalCompleted = appData.dailyEntries.reduce((sum, entry) => sum + safeNumber(entry.completed), 0);
              appData.updatedAt = new Date().toISOString();

              // Save merged data
              await syncToFirestore();
            } else {
              appData = { ...appData, ...remoteData };
            }
            saveLocalData();
            updateUI();
            toast('Data synced successfully!');
          } else {
            // Push local data to remote
            await syncToFirestore();
          }
        } else {
          // First time user, push local data
          await syncToFirestore();
        }

        // Set up real-time listener after initial load
        setupRealtimeListener();
        
      } catch (error) {
        console.error('Error loading from Firestore:', error);
        toast('Failed to sync data. Check your connection.', 'error');
      }
    }

    function handleAuthStateChange(user) {
      const wasGuest = !currentUser;
      currentUser = user;

      updateAuthUI();

      if (user) {
        // User signed in
        console.log('User signed in, setting up sync...');
        if (wasGuest) {
          // Just signed in, merge local guest data and set up real-time sync
          loadFromFirestore();
        } else {
          // Already signed in, just sync and ensure listener is active
          syncToFirestore();
          if (!unsubscribeListener) {
            setupRealtimeListener();
          }
        }
      } else {
        // User signed out or is guest
        console.log('User signed out, removing real-time sync...');
        removeRealtimeListener();
        // Clear profile picture on logout
        appData.profilePicture = null;
        loadLocalData();
        updateUI();
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Handle page visibility changes to maintain connection
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser && !unsubscribeListener) {
        console.log('Page visible, reconnecting real-time sync...');
        setupRealtimeListener();
      }
    });

    // Handle online/offline events
    window.addEventListener('online', () => {
      if (currentUser) {
        console.log('Back online, syncing data...');
        syncToFirestore();
        if (!unsubscribeListener) {
          setupRealtimeListener();
        }
      }
    });

    window.addEventListener('offline', () => {
      console.log('Gone offline, data will sync when back online');
      toast('You are offline. Data will sync when connection is restored.', 'error');
    });
  </script>
</body>

</html>

</body>

</html>
